{% extends "base.html" %}
{% load i18n %}
{% block title %}Manage Accounts{% endblock %}

{% block content %}
<div class="container my-4">
    {# Page header #}
    <h2 class="mb-3">{% trans "Manage User Accounts" %}</h2>

    {# Explanatory text above the table #}
    <p class="text-muted mb-3">
        {% trans "Here you can manage user accounts. Use the buttons above to navigate through the list." %}
    </p>

    {# Display Django messages (success, warning, info, etc.) #}
    {% if messages %}
        <div>
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    {# Search box #}
    <div class="mb-3">
        <input 
            type="text" 
            id="search-box" 
            class="form-control" 
            placeholder="{% trans 'Search by username...' %}"
            autocomplete="off"
        >
    </div>

    {# Pagination buttons placed on top of the table #}
    <div class="d-flex justify-content-between mb-2" id="pagination-controls">
        <button class="btn btn-primary" id="prev-btn" disabled>
            {% trans "Previous" %}
        </button>
        <button class="btn btn-primary" id="next-btn">
            {% trans "Next" %}
        </button>
    </div>

    {# Table displaying user accounts #}
    <table class="table table-bordered table-hover" id="users-table">
        <thead class="table-dark">
            <tr>
                <th>{% trans "Username" %}</th>
                <th>{% trans "Status" %}</th>
                <th>{% trans "Joined" %}</th>
                <th>{% trans "Eligible matches" %}</th>
                <th>{% trans "Score" %} %</th>
                <th>{% trans "Action" %}</th>
            </tr>
        </thead>
        <tbody>
            {# Loop through all users passed from the view #}
            {% for user in users %}
            <tr class="user-row" data-username="{{ user.username|lower }}">
                <td>{{ user.username }}</td>
                <td>
                    {# Display badge depending on user's status #}
                    {% if user.is_disabled %}
                        <span class="badge bg-danger">{% trans "Disabled" %}</span>
                    {% else %}
                        <span class="badge bg-success">{% trans "Active" %}</span>
                    {% endif %}
                </td>
                <td>{{ user.date_joined|date:"Y-m-d" }}</td>
                <td>{{ user.total_eligible }}</td>
                <td>{{ user.score }}</td>
                <td>
                    {# Only allow actions on users other than the current logged-in user #}
                    {% if user != request.user %}
                        <a href="{% url 'toggle_account_status' user.id %}"
                           class="btn {% if user.is_disabled %}btn-success{% else %}btn-danger{% endif %} btn-sm">
                            {# Button text changes depending on current status #}
                            {% if user.is_disabled %}{% trans "Activate" %}{% else %}{% trans "Deactivate" %}{% endif %}
                        </a>
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {# No results row (hidden by default) #}
            <tr id="no-results-row" style="display: none;">
                <td colspan="6" class="text-center text-muted">
                    {% trans "No users found." %}
                </td>
            </tr>
        </tbody>

        {# Caption at the bottom explaining table behavior #}
        <caption class="text-muted" id="table-caption">
            {% trans "Only 10 users are shown at a time. Use the buttons above to see more." %}
        </caption>
    </table>
</div>

{# JavaScript for client-side pagination and search #}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Select all rows in the table (exclude the no-results row)
    const rows = document.querySelectorAll("#users-table .user-row");
    const noResultsRow = document.getElementById("no-results-row");
    const searchBox = document.getElementById("search-box");
    const paginationControls = document.getElementById("pagination-controls");
    const tableCaption = document.getElementById("table-caption");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    
    const pageSize = 10;  // Number of users to show per page
    let currentPage = 0; // Track current page
    let isSearching = false; // Track if search is active

    // Function to show the correct page of rows
    function showPage(page) {
        let visibleCount = 0;
        
        rows.forEach((row, index) => {
            // Show rows within the current page, hide others
            if (index >= page * pageSize && index < (page + 1) * pageSize) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });

        // Enable/disable Previous button if on first page
        prevBtn.disabled = (page === 0);

        // Enable/disable Next button if on last page
        nextBtn.disabled = ((page + 1) * pageSize >= rows.length);
    }

    // Function to filter rows based on search query
    function filterRows(query) {
        const lowerQuery = query.toLowerCase().trim();
        
        if (lowerQuery === "") {
            // Search is empty - restore pagination
            isSearching = false;
            paginationControls.style.display = "flex";
            tableCaption.style.display = "";
            noResultsRow.style.display = "none";
            currentPage = 0;
            showPage(currentPage);
        } else {
            // Search is active - disable pagination and show all matches
            isSearching = true;
            paginationControls.style.display = "none";
            tableCaption.style.display = "none";
            
            let matchCount = 0;
            
            rows.forEach(row => {
                const username = row.getAttribute("data-username");
                if (username.includes(lowerQuery)) {
                    row.style.display = "";
                    matchCount++;
                } else {
                    row.style.display = "none";
                }
            });
            
            // Show "No users found" if no matches
            if (matchCount === 0) {
                noResultsRow.style.display = "";
            } else {
                noResultsRow.style.display = "none";
            }
        }
    }

    // Event listener for search box
    searchBox.addEventListener("input", function() {
        filterRows(this.value);
    });

    // Event listener for Previous button
    prevBtn.addEventListener("click", () => {
        if (currentPage > 0 && !isSearching) {
            currentPage--;
            showPage(currentPage);
        }
    });

    // Event listener for Next button
    nextBtn.addEventListener("click", () => {
        if ((currentPage + 1) * pageSize < rows.length && !isSearching) {
            currentPage++;
            showPage(currentPage);
        }
    });

    // Initialize first page on load
    showPage(currentPage);
});
</script>

<style>
    #search-box {
        max-width: 400px;
    }
    
    #search-box:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}